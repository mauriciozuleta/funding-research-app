{% extends 'base.html' %}
{% block content %}
<div class="container mt-5" style="max-width: 500px;">
  <h2 class="mb-4 text-center">Create Your Account</h2>
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}" role="alert">{{ message }}</div>
    {% endfor %}
  {% endif %}
  <form method="post" id="registerForm">
    {% csrf_token %}
    <div class="mb-3">
      <label for="first_name" class="form-label">First Name</label>
      <input type="text" class="form-control" id="first_name" name="first_name" required value="{{ first_name }}" title="Please enter your first name.">
    </div>
    <div class="mb-3">
      <label for="last_name" class="form-label">Last Name</label>
      <input type="text" class="form-control" id="last_name" name="last_name" required value="{{ last_name }}" title="Please enter your last name.">
    </div>
    <div class="mb-3">
      <label for="email" class="form-label">Email Address</label>
      <input type="email" class="form-control" id="email" name="email" required value="{{ email }}" title="Please enter a valid email address.">
      <div class="form-text">Used for login + notifications</div>
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input type="password" class="form-control" id="password" name="password" required oninput="checkStrength()" title="Please enter a password.">
      <div id="strengthMessage" class="form-text"></div>
    </div>
    <div class="mb-3">
      <label for="confirm_password" class="form-label">Confirm Password</label>
      <input type="password" class="form-control" id="confirm_password" name="confirm_password" required title="Please confirm your password.">
    </div>
    <button type="button" class="btn btn-primary w-100" id="createUserBtn">Create User</button>
    <div id="userProfileSection" style="display:none;">
      <hr class="my-4">
      <h4 class="mb-3">User Profile</h4>
      <div class="mb-3">
        <label for="country" class="form-label">Country <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="country" name="country" required title="Please enter your country." oninvalid="this.setCustomValidity('Please enter your country.')" oninput="this.setCustomValidity('')">
      </div>
      <div class="mb-3">
        <label for="state" class="form-label">State (optional)</label>
        <input type="text" class="form-control" id="state" name="state">
      </div>
      <div class="mb-3">
        <label for="career_stage" class="form-label">Career Stage <span class="text-danger">*</span></label>
        <select class="form-select" id="career_stage" name="career_stage" required title="Please select your career stage." oninvalid="this.setCustomValidity('Please select your career stage.')" oninput="this.setCustomValidity('')">
          <option value="" disabled selected>Select your career stage</option>
          <option>Undergraduate student</option>
          <option>Masterâ€™s student</option>
          <option>PhD student</option>
          <option>Postdoctoral researcher</option>
          <option>Faculty / PI</option>
          <option>Research staff</option>
          <option>Independent researcher</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="discipline" class="form-label">Field / Discipline</label>
        <input type="text" class="form-control" id="discipline" name="discipline" title="Please enter your field or discipline.">
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="ai_consent" name="ai_consent" required oninvalid="this.setCustomValidity('You must consent to the AI disclaimer to continue.')" oninput="this.setCustomValidity('')">
        <label class="form-check-label" for="ai_consent">
          I understand this tool provides AI-generated recommendations and drafts that must be independently reviewed.
        </label>
        <div class="invalid-feedback" id="aiConsentWarning" style="display:none;">You must consent to the AI disclaimer to continue.</div>
      </div>
      <a href="/openai-paypal/" class="btn btn-success w-100" id="continueOpenAI">Continue to open AI registration</a>
    </div>
  </form>

</div>
<script>
function checkStrength() {
  const pwd = document.getElementById('password').value;
  const msg = document.getElementById('strengthMessage');
  let strength = 0;
  if (pwd.length >= 8) strength++;
  if (/[A-Z]/.test(pwd)) strength++;
  if (/[0-9]/.test(pwd)) strength++;
  if (/[^A-Za-z0-9]/.test(pwd)) strength++;
  if (strength === 0) msg.textContent = '';
  else if (strength <= 2) msg.textContent = 'Weak password';
  else if (strength === 3) msg.textContent = 'Medium strength';
  else msg.textContent = 'Strong password';
}

document.getElementById('createUserBtn').addEventListener('click', function() {
  document.getElementById('userProfileSection').style.display = 'block';
  this.style.display = 'none';
});

document.getElementById('registerForm').addEventListener('submit', function(e) {
  var aiConsent = document.getElementById('ai_consent');
  var aiWarning = document.getElementById('aiConsentWarning');
  if (document.getElementById('userProfileSection').style.display === 'block' && !aiConsent.checked) {
    aiWarning.style.display = 'block';
    e.preventDefault();
  } else {
    aiWarning.style.display = 'none';
  }
});
</script>
{% endblock %}
